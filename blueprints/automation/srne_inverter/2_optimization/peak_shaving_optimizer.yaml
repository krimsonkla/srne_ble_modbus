blueprint:
  name: "SRNE Inverter - Peak Shaving Optimizer"
  description: >
    Enhanced peak shaving automation that reduces grid power import during peak hours
    by intelligently using battery power. Includes frequency-based grid stress detection
    and dynamic response to grid conditions.

    Features:
    - Time-based peak hour detection
    - Power threshold-based switching
    - Grid frequency monitoring (>50.2Hz = stressed grid)
    - Adaptive battery reserve management
    - Multi-stage load response
    - Prevents export during grid stress
    - Coordinated with battery protection systems

    Ideal for:
    - Time-of-use (TOU) pricing optimization
    - Grid stability support (frequency response)
    - Demand charge reduction
    - Load shifting strategies
  domain: automation
  author: "SRNE Inverter Integration"
  source_url: https://github.com/krimsonkla/srne_ble_modbus/blueprints/automation/srne_inverter/2_optimization/peak_shaving_optimizer.yaml

  input:
    inverter_device:
      name: SRNE Inverter Device
      description: Select your SRNE Inverter device
      selector:
        device:
          integration: srne_inverter

    grid_power_sensor:
      name: Grid Power Sensor
      description: Grid power import sensor (positive = importing from grid)
      selector:
        entity:
          domain: sensor
          device_class: power

    battery_soc_sensor:
      name: Battery SOC Sensor
      description: Battery State of Charge sensor
      selector:
        entity:
          domain: sensor
          device_class: battery

    grid_frequency_sensor:
      name: Grid Frequency Sensor (Optional)
      description: Grid frequency sensor for stress detection
      default: {}
      selector:
        entity:
          domain: sensor

    # Peak Hours Configuration
    peak_start_time:
      name: Peak Hours Start
      description: When peak pricing begins
      default: "16:00:00"
      selector:
        time:

    peak_end_time:
      name: Peak Hours End
      description: When peak pricing ends
      default: "21:00:00"
      selector:
        time:

    # Power Thresholds
    grid_import_threshold:
      name: Grid Import Threshold
      description: Switch to battery when grid import exceeds this value
      default: 1000
      selector:
        number:
          min: 100
          max: 10000
          step: 100
          unit_of_measurement: "W"

    aggressive_threshold:
      name: Aggressive Shaving Threshold
      description: Higher import level triggers more aggressive battery use
      default: 2000
      selector:
        number:
          min: 500
          max: 15000
          step: 100
          unit_of_measurement: "W"

    # Frequency Response
    frequency_high_threshold:
      name: High Frequency Threshold
      description: Grid frequency above this indicates stressed grid
      default: 50.2
      selector:
        number:
          min: 50.0
          max: 51.0
          step: 0.05
          unit_of_measurement: "Hz"

    frequency_low_threshold:
      name: Low Frequency Threshold
      description: Grid frequency below this indicates weak grid
      default: 49.8
      selector:
        number:
          min: 49.0
          max: 50.0
          step: 0.05
          unit_of_measurement: "Hz"

    enable_frequency_response:
      name: Enable Frequency Response
      description: Respond to grid frequency variations
      default: true
      selector:
        boolean:

    # Battery Management
    minimum_battery_soc:
      name: Minimum Battery SOC
      description: Don't discharge battery below this level
      default: 30
      selector:
        number:
          min: 10
          max: 50
          step: 5
          unit_of_measurement: "%"

    battery_reserve_soc:
      name: Battery Reserve SOC
      description: Reserve level for grid emergencies (frequency response)
      default: 20
      selector:
        number:
          min: 10
          max: 40
          step: 5
          unit_of_measurement: "%"

    # Priority Settings
    priority_select:
      name: Priority Select Entity
      description: Energy priority select entity
      selector:
        entity:
          domain: select

    peak_priority_mode:
      name: Peak Hours Priority
      description: Priority mode during peak hours
      default: "Battery First"
      selector:
        select:
          options:
            - "Battery First"
            - "Solar First"

    aggressive_priority_mode:
      name: Aggressive Shaving Priority
      description: Priority when import exceeds aggressive threshold
      default: "Battery First"
      selector:
        select:
          options:
            - "Battery First"

    off_peak_priority_mode:
      name: Off-Peak Priority
      description: Priority mode outside peak hours
      default: "Solar First"
      selector:
        select:
          options:
            - "Solar First"
            - "Utility First"
            - "PV Priority"

    # Advanced Options
    hysteresis_duration:
      name: Hysteresis Duration
      description: Grid import must exceed threshold for this duration
      default: 2
      selector:
        number:
          min: 0
          max: 10
          step: 1
          unit_of_measurement: "minutes"

    recovery_hysteresis:
      name: Recovery Hysteresis
      description: Grid import must stay below threshold to restore normal mode
      default: 500
      selector:
        number:
          min: 100
          max: 2000
          step: 100
          unit_of_measurement: "W"

    prevent_export_during_stress:
      name: Prevent Export During Grid Stress
      description: Force grid import when frequency high (stressed grid)
      default: true
      selector:
        boolean:

    # Notifications
    send_notification:
      name: Send Notification
      description: Notify when peak shaving is activated/deactivated
      default: true
      selector:
        boolean:

    notification_service:
      name: Notification Service (Optional)
      description: The notification service to use
      default: ""
      selector:
        text:

    notify_frequency_events:
      name: Notify Frequency Events
      description: Send alerts for grid frequency issues
      default: false
      selector:
        boolean:

trigger:
  # Peak hours start
  - platform: time
    at: !input peak_start_time
    id: "peak_start"

  # Peak hours end
  - platform: time
    at: !input peak_end_time
    id: "peak_end"

  # High grid import during peak hours
  - platform: numeric_state
    entity_id: !input grid_power_sensor
    above: !input grid_import_threshold
    for:
      minutes: !input hysteresis_duration
    id: "high_import"

  # Very high grid import (aggressive shaving)
  - platform: numeric_state
    entity_id: !input grid_power_sensor
    above: !input aggressive_threshold
    for:
      minutes: 1
    id: "aggressive_import"

  # Grid import normalized
  - platform: numeric_state
    entity_id: !input grid_power_sensor
    below: !input recovery_hysteresis
    for:
      minutes: !input hysteresis_duration
    id: "import_normalized"

  # High frequency (stressed grid)
  - platform: numeric_state
    entity_id: !input grid_frequency_sensor
    above: !input frequency_high_threshold
    id: "frequency_high"

  # Low frequency (weak grid)
  - platform: numeric_state
    entity_id: !input grid_frequency_sensor
    below: !input frequency_low_threshold
    id: "frequency_low"

  # Frequency normalized
  - platform: numeric_state
    entity_id: !input grid_frequency_sensor
    above: !input frequency_low_threshold
    below: !input frequency_high_threshold
    for:
      minutes: 2
    id: "frequency_normal"

condition: []

action:
  - variables:
      soc: "{{ states(battery_soc_sensor) | float(50) }}"
      grid_power: "{{ states(grid_power_sensor) | float(0) }}"
      grid_freq: >
        {% if grid_frequency_sensor is defined and grid_frequency_sensor != none %}
          {{ states(grid_frequency_sensor) | float(50.0) }}
        {% else %}
          50.0
        {% endif %}
      current_time: "{{ now().strftime('%H:%M:%S') }}"
      peak_start: !input peak_start_time
      peak_end: !input peak_end_time
      is_peak_hours: >
        {% set now_time = current_time %}
        {% set start = peak_start %}
        {% set end = peak_end %}
        {% if start > end %}
          {{ now_time >= start or now_time < end }}
        {% else %}
          {{ start <= now_time < end }}
        {% endif %}
      trigger_id: "{{ trigger.id }}"
      timestamp: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      min_soc: !input minimum_battery_soc
      reserve_soc: !input battery_reserve_soc
      freq_enabled: !input enable_frequency_response

  - choose:
      # ==========================================
      # PEAK HOURS START
      # ==========================================
      - conditions:
          - condition: trigger
            id: "peak_start"
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            above: !input minimum_battery_soc
        sequence:
          # Switch to peak shaving mode
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: !input peak_priority_mode

          # Notify
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ send_notification }}"
                  - condition: template
                    value_template: "{{ notification_service | length > 0 }}"
                sequence:
                  - service: !input notification_service
                    data:
                      title: "ðŸ”‹ Peak Shaving Activated"
                      message: >
                        Peak hours started at {{ timestamp }}.

                        Status:
                        - Priority: {{ peak_priority_mode }}
                        - Battery: {{ soc }}%
                        - Grid Power: {{ grid_power }}W
                        {% if freq_enabled %}
                        - Grid Frequency: {{ grid_freq }}Hz
                        {% endif %}
                      data:
                        tag: "srne_peak_shaving"

          # Log event
          - service: system_log.write
            data:
              message: >
                Peak Shaving: Activated at {{ timestamp }}, SOC {{ soc }}%, grid {{ grid_power }}W
              level: info
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # HIGH GRID IMPORT
      # ==========================================
      - conditions:
          - condition: trigger
            id: "high_import"
          - condition: template
            value_template: "{{ is_peak_hours }}"
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            above: !input minimum_battery_soc
        sequence:
          # Switch to battery priority
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: !input peak_priority_mode

          # Notify
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ send_notification }}"
                  - condition: template
                    value_template: "{{ notification_service | length > 0 }}"
                sequence:
                  - service: !input notification_service
                    data:
                      title: "âš¡ High Grid Import Detected"
                      message: >
                        Grid import {{ grid_power }}W exceeds threshold.

                        Action: Switched to {{ peak_priority_mode }}
                        Battery: {{ soc }}%
                      data:
                        tag: "srne_peak_shaving"

          # Log
          - service: system_log.write
            data:
              message: >
                Peak Shaving: High import {{ grid_power }}W, switched to battery
              level: info
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # AGGRESSIVE IMPORT (VERY HIGH)
      # ==========================================
      - conditions:
          - condition: trigger
            id: "aggressive_import"
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            above: !input battery_reserve_soc
        sequence:
          # Force aggressive battery use
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: !input aggressive_priority_mode

          # Urgent notification
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notification_service | length > 0 }}"
                sequence:
                  - service: !input notification_service
                    data:
                      title: "ðŸš¨ Very High Grid Import"
                      message: >
                        ALERT: Grid import {{ grid_power }}W very high!

                        Action: Aggressive peak shaving
                        Battery: {{ soc }}%
                      data:
                        priority: high
                        tag: "srne_aggressive_shaving"

          # Log critical event
          - service: system_log.write
            data:
              message: >
                Peak Shaving: AGGRESSIVE mode - import {{ grid_power }}W
              level: warning
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # GRID FREQUENCY HIGH (STRESSED GRID)
      # ==========================================
      - conditions:
          - condition: trigger
            id: "frequency_high"
          - condition: template
            value_template: "{{ freq_enabled }}"
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            above: !input battery_reserve_soc
        sequence:
          # Force grid import to support stressed grid
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ prevent_export_during_stress }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: !input priority_select
                    data:
                      option: "Utility First"

          # Notify frequency event
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_frequency_events }}"
                  - condition: template
                    value_template: "{{ notification_service | length > 0 }}"
                sequence:
                  - service: !input notification_service
                    data:
                      title: "âš¡ Grid Frequency High"
                      message: >
                        Grid frequency {{ grid_freq }}Hz indicates stressed grid.

                        Action: Supporting grid stability
                        {% if prevent_export_during_stress %}
                        Export prevented
                        {% endif %}
                        Battery: {{ soc }}%
                      data:
                        priority: high
                        tag: "srne_frequency_response"

          # Log frequency event
          - service: system_log.write
            data:
              message: >
                Frequency Response: High frequency {{ grid_freq }}Hz, supporting grid
              level: warning
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # GRID FREQUENCY LOW (WEAK GRID)
      # ==========================================
      - conditions:
          - condition: trigger
            id: "frequency_low"
          - condition: template
            value_template: "{{ freq_enabled }}"
          - condition: numeric_state
            entity_id: !input battery_soc_sensor
            above: !input battery_reserve_soc
        sequence:
          # Switch to battery to support weak grid
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: "Battery First"

          # Notify frequency event
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ notify_frequency_events }}"
                  - condition: template
                    value_template: "{{ notification_service | length > 0 }}"
                sequence:
                  - service: !input notification_service
                    data:
                      title: "âš¡ Grid Frequency Low"
                      message: >
                        Grid frequency {{ grid_freq }}Hz indicates weak grid.

                        Action: Switched to battery support
                        Battery: {{ soc }}%
                      data:
                        priority: high
                        tag: "srne_frequency_response"

          # Log frequency event
          - service: system_log.write
            data:
              message: >
                Frequency Response: Low frequency {{ grid_freq }}Hz, using battery
              level: warning
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # FREQUENCY NORMALIZED
      # ==========================================
      - conditions:
          - condition: trigger
            id: "frequency_normal"
          - condition: template
            value_template: "{{ freq_enabled }}"
        sequence:
          # Restore appropriate priority based on time
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: >
                {% if is_peak_hours %}
                  {{ peak_priority_mode }}
                {% else %}
                  {{ off_peak_priority_mode }}
                {% endif %}

          # Log recovery
          - service: system_log.write
            data:
              message: >
                Frequency Response: Normalized {{ grid_freq }}Hz, restored normal operation
              level: info
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # GRID IMPORT NORMALIZED
      # ==========================================
      - conditions:
          - condition: trigger
            id: "import_normalized"
          - condition: template
            value_template: "{{ is_peak_hours }}"
        sequence:
          # Return to normal peak mode
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: !input peak_priority_mode

          # Log
          - service: system_log.write
            data:
              message: >
                Peak Shaving: Import normalized {{ grid_power }}W
              level: info
              logger: homeassistant.components.srne_inverter

      # ==========================================
      # PEAK HOURS END
      # ==========================================
      - conditions:
          - condition: trigger
            id: "peak_end"
        sequence:
          # Restore off-peak priority
          - service: select.select_option
            target:
              entity_id: !input priority_select
            data:
              option: !input off_peak_priority_mode

          # Notify
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ send_notification }}"
                  - condition: template
                    value_template: "{{ notification_service | length > 0 }}"
                sequence:
                  - service: !input notification_service
                    data:
                      title: "âœ… Peak Hours Ended"
                      message: >
                        Peak shaving period ended at {{ timestamp }}.

                        Status:
                        - Restored {{ off_peak_priority_mode }}
                        - Final Battery: {{ soc }}%
                        - Grid Power: {{ grid_power }}W
                      data:
                        tag: "srne_peak_shaving"

          # Log completion
          - service: system_log.write
            data:
              message: >
                Peak Shaving: Ended at {{ timestamp }}, final SOC {{ soc }}%
              level: info
              logger: homeassistant.components.srne_inverter

mode: single
max_exceeded: silent
